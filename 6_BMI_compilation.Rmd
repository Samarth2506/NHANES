# Prepross
```{r include=F,warning=FALSE,message=FALSE}
# rm(list = ls())
if(T){
  library(rnhanesdata)
  library(tidyverse)
  library(magrittr)
  library(data.table)
  library(randomForest)
  library(caret)
  library(keras)
  library(tensorflow)
  library(caTools)
  library(mgcv)
  library(boot)
  library(car)
  # library(PCAtools)
}
# https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PAXRAW_D.htm
```

```{r}
table(Covariate_D %>% filter(SEQN %in% analyticData$SEQN) %>% select(BMI_cat))
```


# pre processing
```{r include=F}
rm(list = ls())
keep_inx <- exclude_accel(act = PAXINTEN_D, flags = Flags_D)
accel_good_D <- PAXINTEN_D[keep_inx,] 
flags_good_D <- Flags_D[keep_inx,]


MIN_name = grep('MIN',colnames(accel_good_D),value = T)
MINdata = data.frame(SEQN = accel_good_D[,'SEQN'],accel_good_D[,MIN_name] * flags_good_D[,MIN_name]) %>%
  group_by(SEQN) %>% summarise_each(funs(mean)) %>% as.data.frame() %>% na.omit()

if(F){
  pca_model = prcomp(MINdata %>% select(-SEQN),
                     center = T,
                     scale. = T)
  save(pca_model,file= 'pca_model.rda')
}
load(file = 'pca_model.rda')

# summary(pca_model)

if(F){
eigs <- pca_model$sdev^2
cbind(
  SD = sqrt(eigs),
  Proportion = eigs/sum(eigs),
  Cumulative = cumsum(eigs)/sum(eigs))
}


stats::screeplot(pca_model)

analyticData = data.frame(SEQN=MINdata$SEQN,
                          pca_model$x) %>% 
  inner_join(Covariate_D %>% select(SEQN,Race,Gender,RIDAGEYR,BMI),by = 'SEQN') %>% 
  na.omit() 
# > quantile(analyticData$BMI,probs = 0.05)
#      5% 
# 15.9695 
# > quantile(analyticData$BMI,probs = 0.95)
#    95% 
# 39.151
analyticData = analyticData %>% filter(15 <BMI & BMI< 40)



save(MIN_name,MINdata,analyticData,file = 'analyticData.rda')
```


# PCA tools
```{r}
  # pca_model = prcomp(MINdata %>% select(-SEQN),
  #                    center = T,
  #                    scale. = T)
  # save(pca_model,file= 'pca_model.rda')
if(F){
load(file = 'analyticData.rda')

p <- pca(MINdata %>% select(-SEQN))
horn <- parallelPCA(MINdata %>% select(-SEQN))
horn$n
# [1] 76
elbow <- findElbowPoint(p$variance)
elbow
#   16 

save(horn,elbow,file = 'PCAtools.rda')
library(ggplot2)

screeplot(p,
  components = getComponents(p, 1:20),
  vline = c(horn$n, elbow)) +
  geom_text(aes(horn$n + 1, 50, label = "Horn's", vjust = -1)) +
  geom_text(aes(elbow + 1, 50, label = "Elbow", vjust = -1))
}
```



```{r}
rm(list = ls())
load(file = 'analyticData.rda')
Y = analyticData
PCnames = paste('PC',1:5,sep = '')
y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
colnames(y)
if(F){
fit = randomForest(BMI ~ ., data = y,ntree = 501,
                   importance = T)
save(fit,file = 'rffit.rda')
}
load(file = 'rffit.rda')
varImpPlot(fit)

importance(fit)

y_cor <- as.data.frame(
  lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.numeric  else x))

res_cor = cor(y_cor)
library(corrplot)
corrplot(res_cor,
         metho = 'color',
         type = 'upper',
         order = 'hclust',
         addCoef.col = "black",
         diag = F)

```



```{r}
load(file = 'pca_model.rda')
temp = pca_model$rotation
plot(( 1 : nrow(temp)) / 60, temp[,1],type = 'l',
     xlab = "Time of Day",ylab = "Variable Loadings on PC1")
plot(( 1 : nrow(temp)) / 60, temp[,2],type = 'l',
     xlab = "Time of Day",ylab = "Variable Loadings on PC2")
plot(( 1 : nrow(temp)) / 60, temp[,3],type = 'l',
     xlab = "Time of Day",ylab = "Variable Loadings on PC3")
plot(( 1 : nrow(temp)) / 60, temp[,4],type = 'l',
     xlab = "Time of Day",ylab = "Variable Loadings on PC4")
plot(( 1 : nrow(temp)) / 60, temp[,5],type = 'l',
     xlab = "Time of Day",ylab = "Variable Loadings on PC5")

```



# Cross-validation
```{r}
rm(list = ls())
load(file = 'analyticData.rda')
res_RMSE = c()
res_Rsquared = c()
if(F){
for(i in 1:50){
  PCnames = paste('PC',1:i,sep = '')
  data_ctrl = trainControl(method = 'cv',number =10)
  dat = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)]
  # dat$BMI = log(dat$BMI + 1) # 
  model = caret::train(BMI~.,
                data= dat,
                trControl = data_ctrl,
                method = 'lm',
                na.action = na.pass
                )
  res_RMSE = c(res_RMSE,mean(model$resample$RMSE))
  res_Rsquared = c(res_Rsquared,mean(model$resample$Rsquared))
  
}
  save(res_RMSE,res_Rsquared, file = 'CV_50PCs.rda')
}
load(file = 'CV_50PCs.rda')

ggplot(data.frame(res_RMSE)) + 
  aes(x = 1:length(res_RMSE), y = res_RMSE) +
  geom_line()+
  # geom_smooth(se = TRUE, method = 'lm')+
  geom_smooth(se = TRUE, method =  'auto',color = 'blue')

ggplot(data.frame(res_Rsquared)) + 
  aes(x = 1:length(res_Rsquared), y = res_Rsquared) +
  geom_line()+
  # geom_smooth(se = TRUE, method = 'lm')+
  geom_smooth(se = TRUE, method =  'auto',color = 'blue')

which(res_RMSE==min(res_RMSE))
which(res_Rsquared==max(res_Rsquared))
# load(file = 'CV_300PCs.rda')
# 
# 
# ggplot(data.frame(res_RMSE)) + 
#   aes(x = 1:length(res_RMSE), y = res_RMSE) +
#   geom_line()+
#   # geom_smooth(se = TRUE, method = 'lm')+
#   geom_smooth(se = TRUE, method =  'auto',color = 'blue')
# 
# ggplot(data.frame(res_Rsquared)) + 
#   aes(x = 1:length(res_Rsquared), y = res_Rsquared) +
#   geom_line()+
#   # geom_smooth(se = TRUE, method = 'lm')+
#   geom_smooth(se = TRUE, method =  'auto',color = 'blue')
# plot(res_RMSE,type = 'l')
# plot(res_Rsquared,type = 'l')

```
# ANOVA
```{r}
models = list()
for (i in 1:15){
  PCnames = paste('PC',1:i,sep = '')
  y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
  set.seed(111)
  trainidx = sample(nrow(y),0.7*nrow(y))
  model = lm(BMI ~., data = y, subset = trainidx)
  models = c(models,list(model))
}
# PCnames = paste('PC',1:3,sep = '')
# y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
# fit0 = lm(BMI ~., data = y, subset = trainidx)
# PCnames = paste('PC',1:5,sep = '')
# y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
# fit1 = lm(BMI ~., data = y, subset = trainidx)
# PCnames = paste('PC',1:10,sep = '')
# y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
# fit2 = lm(BMI ~., data = y, subset = trainidx)
# PCnames = paste('PC',1:13,sep = '')
# y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
# fit3 = lm(BMI ~., data = y, subset = trainidx)

do.call(anova,models)
```



# PCs + nutrition info
```{r}
rm(list =ls())
load(file = 'analyticData.rda')
PCnames = paste('PC',1:5,sep = '')
Y = analyticData[,c('RIDAGEYR','Race','Gender','BMI',PCnames)] %>% na.omit()
y = Y
yTrue = y$BMI
# y = as.data.frame(lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.factor() else x))
set.seed(111)
trainidx = sample(nrow(y),0.7*nrow(y))


# y$BMI = log(y$BMI +1)



fit = lm(BMI ~ .,data = y, subset = trainidx)


# anova(fit,fit2)
summary(fit)
# summary(fit2)

avPlots(glm(BMI ~ .,data = y, subset = trainidx),ask = FALSE)
if(F){
vif(fit)
}
# y_cor <- as.data.frame(
#   lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.numeric  else x))
# res_cor = cor(y_cor)
# library(corrplot)
# corrplot(res_cor,
#          metho = 'color',
#          type = 'upper',
#          order = 'hclust',
#          addCoef.col = "black",
#          diag = F)

# yPred = exp(predict(fit,y[-trainidx,]))-1
yPred = predict(fit,y[-trainidx,])
yTrue = yTrue[-trainidx]
result = cbind(yPred,
               yTrue) %>% as.data.frame() %>% na.omit()
# MSE of yPred and yTrue
mean((yPred-yTrue)^2)
# mean((result[,1]-result[,2])^2)

ggplot(data=result , aes(x = 1:dim(result)[1])) + 
  geom_line(aes(y = yPred),color = 'red') + 
  geom_line(aes(y = yTrue),color = 'blue') +
  labs(x = 'Patients', y = 'BMI',
       title  = "PCs + Age + Race + Gender")


ggplot(data = result) + 
  aes(x = yTrue, y = yPred) +
  geom_point()+
  geom_smooth(se = TRUE, method = 'lm')+
  geom_smooth(se = TRUE, method =  'auto',color = 'red')

# plot(fit2,which = 1,main = "interaction term added")
plot(fit,which = 1)
```




# try different window size
```{r}
if(F){
err = rep(0,10)
for (d in 1:10){
MINdata_smooth = MINdata[,MIN_name] %>%
  apply(MARGIN = 2, function(i) runmean(i,k=d))
MINdata_smooth = data.frame(SEQN = MINdata$SEQN,MINdata_smooth)
pca_smooth = prcomp(MINdata_smooth %>% select(-SEQN),
                 center = T,
                 scale. = T)

y = data.frame(SEQN= MINdata_smooth$SEQN,pca_smooth$x[,1:5]) %>% 
  left_join(Covariate_D[,c('RIDAGEYR','Race','Gender','BMI','SEQN')],by = 'SEQN')
y = y[,c('RIDAGEYR','Race','Gender','BMI','PC1','PC2','PC3','PC4','PC5')] %>% na.omit()

yTrue = y$BMI

y$BMI = log(y$BMI+1)

fit = lm(BMI ~ .,data = y, subset = trainidx)
summary(fit)

yPred = exp(predict(fit,y[-trainidx,]))-1
yTrue = yTrue[-trainidx]
result = cbind(yPred,
               yTrue) %>% as.data.frame() %>% na.omit()


err[d] = mean((result[,1]-result[,2])^2)
}
err
}
# > err
#  [1] 47.93726 49.89128 50.71071 51.17472 51.32988 51.30029 51.16800 51.16298 51.10647
# [10] 51.17049
```






