# Prepross
```{r include=F}
rm(list = ls())
if(T){
  library(rnhanesdata)
  library(tidyverse)
  library(magrittr)
  library(data.table)
  library(randomForest)
  library(caret)
  library(keras)
  library(tensorflow)
  library(caTools)
}
# https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PAXRAW_D.htm
```


```{r include=F}
rm(list = ls())
keep_inx <- exclude_accel(act = PAXINTEN_D, flags = Flags_D)
accel_good_D <- PAXINTEN_D[keep_inx,] 
flags_good_D <- Flags_D[keep_inx,]


# dot multiply / sumup over min
MINdata = data.frame(accel_good_D[,1:5],accel_good_D[,6:dim(accel_good_D)[2]] *
                       flags_good_D[,6:dim(accel_good_D)[2]]) %>% 
  select(-WEEKDAY) %>% group_by(SEQN) %>% summarise_each(funs(mean)) %>% as.data.frame() %>%
  select(-PAXCAL,-PAXSTAT,-SDDSRVYR) %>% na.omit()

if(F){
pca = prcomp(MINdata %>% select(-SEQN),
             center = T,
             scale. = T)
save(pca,file = 'pca.rda')
}

# smooth before PCA
MINdata_smooth = MINdata[,grep('MIN',colnames(MINdata),value = T)] %>%
  apply(MARGIN = 2, function(i) runmean(i,k=10))
MINdata_smooth = data.frame(SEQN = MINdata$SEQN,MINdata_smooth)
if(F){
pca_smooth = prcomp(MINdata_smooth %>% select(-SEQN),
                 center = T,
                 scale. = T)
save(pca_smooth,file  = 'pca_smooth.rda')}

analyticData = data.frame(SEQN=MINdata_smooth$SEQN,
                          pca_smooth$x) %>% inner_join(Covariate_D,by = 'SEQN') %>% 
  na.omit() %>% select(-SDDSRVYR,-SDMVPSU,-SDMVSTRA,-WTINT2YR,-WTMEC2YR,-RIDAGEMN,-RIDAGEEX)%>%
  filter(15<BMI & BMI<55)

analyticData = analyticData %>% mutate('logbmi' = log(analyticData$BMI +1))

if(F){save(analyticData,file = 'BMI.rda')}

```

# lm(BMI ~ 500 PCs)
```{r}
rm(list = ls())
load(file = 'BMI.rda')
analyticData = analyticData %>% select(-SEQN)


y = analyticData[,c(1:500,which(colnames(analyticData) == 'logbmi'))]

set.seed(100)
trainidx = sample(nrow(y),0.7*nrow(y))

fit = lm( logbmi ~., data = y, subset = trainidx)
# summary(fit)
yPred = exp(predict(fit,y[-trainidx,]))-1
result = cbind(yTrue = analyticData[-trainidx,'BMI'],
               yPred) %>% as.data.frame()


# MSE of yPred and yTrue
mean((result[,1]-result[,2])^2)
# result %>% mutate(Pred_cat = )


# visualization
library(ggplot2)
ggplot(data=result , aes(x = 1:dim(result)[1])) + 
  geom_line(aes(y = yPred),color = 'red') + 
  geom_line(aes(y = yTrue),color = 'blue') + 
  labs(x = 'Patients', y = 'BMI',
        title  = "First 500 PCs included")
  

ggplot(data = result) + 
  aes(x = yTrue, y = yPred) +
  geom_line()
```


```{r}
rm(list = ls())
load(file = 'BMI.rda')
y = analyticData %>% select(-SEQN)
y = y[,c(1:5,1441:1456)] %>% select(-BMI_cat,-logbmi)
colnames(y)
fit = randomForest(BMI ~ ., data = y,ntree = 501,
                   importance = T)
varImpPlot(fit)

y_cor <- as.data.frame(
  lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.numeric  else x))

res_cor = cor(y_cor %>% select(-BMI))
library(corrplot)
corrplot(res_cor,
         type = 'upper',
         order = 'hclust',
         diag = F)

```


# first 5 PCs + nutrition info
```{r}
rm(list = ls())
load(file = 'BMI.rda')
analyticData = analyticData %>% select(-SEQN)
# Y = analyticData[,c(1:6,which(colnames(ana) == 'log'))] %>% 
#   left_join(Covariate_D[,c('SEQN','RIDAGEYR','Gender','Race','BMI_cat')],by = 'SEQN') %>%
#   select(-SEQN)
Y = analyticData[,c(1:5,1441:1456)]
yTrue = analyticData$BMI
y = Y %>% select(-BMI,-BMI_cat)
y = as.data.frame(lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.factor() else x))


set.seed(111)
trainidx = sample(nrow(y),0.7*nrow(y))
# fit = lm(log ~ PC1 + PC2 + PC3  + PC4 + PC5 + RIDAGEYR + Gender, data = ysub, subset = trainidx)
 
fit = lm(logbmi ~ .,data = y, subset = trainidx)
summary(fit)

yPred = exp(predict(fit,y[-trainidx,]))-1
yTrue = yTrue[-trainidx]
result = cbind(yPred,
               yTrue) %>% as.data.frame()
# MSE of yPred and yTrue
mean((result[,1]-result[,2])^2)

ggplot(data=result , aes(x = 1:dim(result)[1])) + 
  geom_line(aes(y = yPred),color = 'red') + 
  geom_line(aes(y = yTrue),color = 'blue') +
  labs(x = 'Patients', y = 'BMI',
       title  = "First 5 PCs/Nutrition_info included")


ggplot(data = result) + 
  aes(x = yTrue, y = yPred) +
  geom_line()

```

```{r}
rm(list = ls())
keep_inx <- exclude_accel(act = PAXINTEN_D, flags = Flags_D)
accel_good_D <- PAXINTEN_D[keep_inx,] 
flags_good_D <- Flags_D[keep_inx,]

MINdata = data.frame(accel_good_D[,1:5],accel_good_D[,6:dim(accel_good_D)[2]] *
                       flags_good_D[,6:dim(accel_good_D)[2]]) %>% 
  select(-WEEKDAY) %>% group_by(SEQN) %>% summarise_each(funs(mean)) %>% as.data.frame() %>%
  select(-PAXCAL,-PAXSTAT,-SDDSRVYR) %>% na.omit()
if(F){
pca = prcomp(MINdata %>% select(-SEQN),
             center = T,
             scale. = T)
save(pca,file = 'pca.rda')
}
load(file = 'pca.rda')
temp = pca$rotation
plot(( 1 : nrow(temp)) / 60, temp[,1],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,2],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,3],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,4],type = 'l')
```


```{r}
MINdata_smooth = MINdata[,grep('MIN',colnames(MINdata),value = T)] %>%
  apply(MARGIN = 2, function(i) runmean(i,k=10))
MINdata_smooth = data.frame(SEQN = MINdata$SEQN,MINdata_smooth)
if(F){
pca_bmi = prcomp(MINdata_smooth %>% select(-SEQN),
                 center = T,
                 scale. = T)
save(pca_bmi,file = 'pca_bmi.rda')
}
load(file = 'pca_bmi.rda')
temp = pca_bmi$rotation
plot(( 1 : nrow(temp)) / 60, temp[,1],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,2],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,3],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,4],type = 'l')
```

# PC scores vs. BMI
```{r}
if(F){
rm(list = ls())
load(file ='BMI.rda')
data = pcscore  %>%
  left_join(Covariate_D[,c('SEQN','RIDAGEYR','Gender','Race','BMI_cat')],by = 'SEQN')
data = data %>% select(c(1:5),BMI,Race)


library(ggplot2)

ggplot(data)+
  aes(x = BMI,y = PC1, colour = Race, group = Race) + 
  geom_line() +
  labs(title = 'PC1')

ggplot(data)+
  aes(x = BMI,y = PC3, colour = Race, group = Race) + 
  geom_line() +
  labs(title = 'PC3')

ggplot(data) + 
  aes(x = BMI,y = PC3) +
  geom_line() + 
  labs(title = 'PC3')

ggplot(data %>% filter(Race == "Mexican American")) + 
  aes(x = BMI,y = PC3) +
  geom_line() + 
  labs(title = 'Maxican American')
  

ggplot(data %>% filter(Race == "Black")) + 
  aes(x = BMI,y = PC3) +
  geom_line() + 
  labs(title = 'Black')
}
```

