# Prepross
```{r include=F}
rm(list = ls())
if(T){
  library(rnhanesdata)
  library(tidyverse)
  library(magrittr)
  library(data.table)
  library(randomForest)
  library(caret)
  library(keras)
  library(tensorflow)
  library(caTools)
  library(mgcv)
  library(boot)
}
# https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PAXRAW_D.htm
```

# pre processing
```{r include=F}
rm(list = ls())
keep_inx <- exclude_accel(act = PAXINTEN_D, flags = Flags_D)
accel_good_D <- PAXINTEN_D[keep_inx,] 
flags_good_D <- Flags_D[keep_inx,]


MIN_name = grep('MIN',colnames(accel_good_D),value = T)
MINdata = data.frame(SEQN = accel_good_D[,'SEQN'],accel_good_D[,MIN_name] * flags_good_D[,MIN_name]) %>%
  group_by(SEQN) %>% summarise_each(funs(mean)) %>% as.data.frame() %>% na.omit()

if(F){
  pca_model = prcomp(MINdata %>% select(-SEQN),
                     center = T,
                     scale. = T)
  save(pca_model,file= 'pca_model.rda')
}
load(file = 'pca_model.rda')

screeplot(pca_model)
analyticData = data.frame(SEQN=MINdata$SEQN,
                          pca_model$x) %>% 
  inner_join(Covariate_D %>% select(SEQN,Race,Gender,RIDAGEYR,BMI),by = 'SEQN') %>% 
  na.omit() %>% filter(10 <BMI & BMI<60)

save(MIN_name,MINdata,analyticData,file = 'analyticData.rda')
```




```{r}
rm(list = ls())
load(file = 'analyticData.rda')
Y = analyticData
y = analyticData[,c('RIDAGEYR','Race','Gender','BMI','PC1','PC2','PC3','PC4','PC5')] %>% na.omit()
colnames(y)
if(F){
fit = randomForest(BMI ~ ., data = y,ntree = 501,
                   importance = T)
save(fit,file = 'rffit.rda')
}
load(file = 'rffit.rda')
varImpPlot(fit)

importance(fit)

y_cor <- as.data.frame(
  lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.numeric  else x))

res_cor = cor(y_cor)
library(corrplot)
corrplot(res_cor,
         metho = 'color',
         type = 'upper',
         order = 'hclust',
         addCoef.col = "black",
         diag = F)

```



```{r}
load(file = 'pca_model.rda')
temp = pca_model$rotation
plot(( 1 : nrow(temp)) / 60, temp[,1],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,2],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,3],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,4],type = 'l')
plot(( 1 : nrow(temp)) / 60, temp[,5],type = 'l')
```


# first 5 PCs + nutrition info
```{r}
rm(list =ls())
load(file = 'analyticData.rda')
Y = analyticData[,c('RIDAGEYR','Race','Gender','BMI','PC1','PC2','PC3','PC4','PC5')] %>% na.omit()
y = Y
yTrue = y$BMI
# y = as.data.frame(lapply(y, function (x) if (is.factor(x)) unclass(x) %>% as.factor() else x))
set.seed(111)
trainidx = sample(nrow(y),0.7*nrow(y))


y$BMI = log(y$BMI +1)


# fit2 = lm(BMI~. + RIDAGEYR:PC1,data = y, subset = trainidx)
fit = lm(BMI ~ .,data = y, subset = trainidx)

# anova(fit,fit2)

summary(fit)
# summary(fit2)

yPred = exp(predict(fit,y[-trainidx,]))-1
yTrue = yTrue[-trainidx]
result = cbind(yPred,
               yTrue) %>% as.data.frame() %>% na.omit()
# MSE of yPred and yTrue
mean((result[,1]-result[,2])^2)

ggplot(data=result , aes(x = 1:dim(result)[1])) + 
  geom_line(aes(y = yPred),color = 'red') + 
  geom_line(aes(y = yTrue),color = 'blue') +
  labs(x = 'Patients', y = 'BMI',
       title  = "First 5 PCs + Age + Race + Gender")


ggplot(data = result) + 
  aes(x = yTrue, y = yPred) +
  geom_point()+
  geom_smooth(se = TRUE, method = 'lm')
  # + geom_smooth(se = TRUE, method =  'auto')

# plot(fit2,which = 1,main = "interaction term added")
plot(fit,which = 1)
```



# try different window size
```{r}
if(F){
err = rep(0,10)
for (d in 1:10){
MINdata_smooth = MINdata[,MIN_name] %>%
  apply(MARGIN = 2, function(i) runmean(i,k=d))
MINdata_smooth = data.frame(SEQN = MINdata$SEQN,MINdata_smooth)
pca_smooth = prcomp(MINdata_smooth %>% select(-SEQN),
                 center = T,
                 scale. = T)

y = data.frame(SEQN= MINdata_smooth$SEQN,pca_smooth$x[,1:5]) %>% 
  left_join(Covariate_D[,c('RIDAGEYR','Race','Gender','BMI','SEQN')],by = 'SEQN')
y = y[,c('RIDAGEYR','Race','Gender','BMI','PC1','PC2','PC3','PC4','PC5')] %>% na.omit()

yTrue = y$BMI

y$BMI = log(y$BMI+1)

fit = lm(BMI ~ .,data = y, subset = trainidx)
summary(fit)

yPred = exp(predict(fit,y[-trainidx,]))-1
yTrue = yTrue[-trainidx]
result = cbind(yPred,
               yTrue) %>% as.data.frame() %>% na.omit()


err[d] = mean((result[,1]-result[,2])^2)
}
err
}
# > err
#  [1] 47.93726 49.89128 50.71071 51.17472 51.32988 51.30029 51.16800 51.16298 51.10647
# [10] 51.17049
```



